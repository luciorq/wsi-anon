<html>
<head>
<meta charset="utf-8"/>
<script type="module">
import AnonymizedStream from './bin/wsi-anon.js';

async function onAnonymizeWsi() {
  const files = document.getElementById("file-input").files;
  const chunkSize = 10 * 1000*1000;

  // only for MIRAX
  const dir = document.getElementById("dir-input").files;
  var anonStream;
  if (typeof dir[0] !== 'undefined'){
    anonStream = AnonymizedStream.create(dir[0], chunkSize);
    for(let i = 1; i < dir.length; i++){
      AnonymizedStream.create(dir[i], chunkSize, dir[0].name.split('.')[0]);
    }
  }

  console.log("running anonymization ...");
  try {
    await anonStream.anonymize();
    console.log("done, stream can now be uploaded");
  } catch (error) {
    alert(error);
  }
}

async function downloadWSI(){
  if( !("showSaveFilePicker" in self) ) {
    throw new Error( "unsupported browser" );
  }
  const handle = await showSaveFilePicker();
  const filestream = await handle.createWritable();
  const writer = await filestream.getWriter();
  var files = document.getElementById("dir-input").files;
  var retrievedFile = AnonymizedStream.retrieve(files[files.length-1].name, files[0].name.split('.')[0])
  console.log(files[files.length-1].name)
  console.log(files[0].name.split('.')[0])
  console.log(retrievedFile)
  retrievedFile.read().then((value, done) => writer.write(value));  // ToDo: make sure that the object is properly written to a file before writer is closed 
  writer.close();
}

window.globalThis.onAnonymizeWsi = onAnonymizeWsi;
window.globalThis.downloadWSI = downloadWSI;
</script>
<title>wsi-anon WASM example</title>
</head>
<body>
<h2>WSI-Anon WASM</h2>
<input id="file-input" type="file" accept=".svs,.mrxs,.ndpi,.tif,.bif,.isyntax"></input>
<p>(Accepted file formats: '.svs', '.ndpi', '.tif', '.bif', '.isyntax')</br></br></br></p>
<input id="dir-input" type="file" webkitdirectory></input>
<p>(ONLY for '.mrxs': please select the directory that contains the '.mrxs' and the corresponding subfolder and upload them)</br></br></br></p>
<p>Open the console to see the result!</p>
<button onclick="onAnonymizeWsi()">Anonymize WSI</button>
<button onclick="downloadWSI()">Download WSI</button>
</body>